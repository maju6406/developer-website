---
path: '/automate-workflows/automated-tagging'
duration: '30 min'
title: 'Automate tagging of your entire stack'
template: 'GuideTemplate'
description: 'A quick demo application that automates the provisioning, deployment, instrumentation, and tagging of a simple app.'
tileShorthand:
  title: 'Automatically tag a simple "Hello World" Demo across the entire stack'
  description: 'See how easy it is to leverage automation in your DevOps environment!'
resources:
  - title: 'Quickly tag a set of resources'
    url: /automate-workflows/5-mins-tag-resources
  - title: 'Tagging: Use tags to organize and group what you monitor'
    url: https://docs.newrelic.com/docs/new-relic-one/use-new-relic-one/core-concepts/tagging-use-tags-organize-group-what-you-monitor
---

<Intro>

Organizing your services, hosts, and applications in New Relic can be challenging, especially as resources come and go. One strategy that you can use to overcome this challenge is to apply [tags](https://docs.newrelic.com/docs/new-relic-one/use-new-relic-one/core-concepts/tagging-use-tags-organize-group-what-you-monitor), consistently, across your stack. Using a few existing tools, you can automatically spin up infrastructure to see tags in action!

In this guide, you will:

- Provision a host on AWS
- Deploy a small Node.js app on that host
- Instrument the host and the application with New Relic agents
- Apply consistent tags across all your [entities](https://docs.newrelic.com/docs/new-relic-one/use-new-relic-one/core-concepts/what-entity-new-relic)
- Teardown everything you made, when you're done

In the next section, you'll learn about the tools you'll use throughout this guide to perform some of your tasks.

</Intro>

## Before you begin

Throughout this guide, you'll use three open source projects to automatically set up, instrument, and teardown your infrastructure:

- [Demo Deployer](https://github.com/newrelic/demo-deployer): The engine that drives all the automation
- [Demo Nodetron](https://github.com/newrelic/demo-nodetron): A Node.js app that you will provision on your host. It will present a web page and an API, which you will use to generate traffic.
- [Demo New Relic Instrumentation](https://github.com/newrelic/demo-newrelic-instrumentation): A project that you will use to instrument your host and application

Each project is distinct, and encapsulates its own behavior. This maintains a separation of concerns and allows you to compose complex scenarios using a modular approach.

<Tip title="Collaborate with us">

The Demo Deployer is currently in development. Because of our commitment to open source, we are working in the open early in the process and invite you to collaborate with us. Drop any thoughts and comments in the [Build on New Relic](https://discuss.newrelic.com/c/build-on-new-relic) support thread, and let us know what you think!

</Tip>

Now that you have a high-level understanding of the tools you will use, you can begin by building the Demo Deployer!

<Steps>

<Step>

## Build the Deployer

To use the Demo Deployer, you will first need to clone its repository from GitHub. After you have a local copy of the code, you will use it to build a Docker image.

<Important>

This guide requires that you have [Docker](https://docs.docker.com/get-docker/) installed on your local machine.

</Important>

First, clone the repository from GitHub:

```shell
git clone https://github.com/newrelic/demo-deployer.git
```

Second, build the `deployer` Docker image:

```shell
docker build -t deployer demo-deployer
```

Now, you have a Docker image, named `deployer`, which you will use throughout the rest of this guide.

</Step>

<Step>

## Configure your credentials

In this guide, you will provision a host on AWS. The Deployer uses a configuration file that contains your credentials for each service it communicates with so that it can invoke the necessary APIs.

You can follow the [User Config documentation](https://github.com/newrelic/demo-deployer/blob/main/documentation/user_config/README.md) in the Deployer repository to set up each account and create your configuration file. In the end, you will have a JSON file that contains credentials for [AWS](https://github.com/newrelic/demo-deployer/blob/main/documentation/user_config/credentials/aws/README.md), [New Relic](https://github.com/newrelic/demo-deployer/blob/main/documentation/user_config/credentials/newrelic/README.md), and [GitHub](https://github.com/newrelic/demo-deployer/blob/main/documentation/user_config/credentials/git/README.md):

```json
{
  "credentials": {
    "aws": {
      "apiKey": "my_aws_api_key",
      "secretKey": "my_aws_secret_key",
      "secretKeyPath": "/path/to/my/secretkey.pem",
      "region": "my_aws_region"
    },
    "newrelic": {
      "licenseKey": "my_new_relic_license_key",
      "accountId": "my_new_relic_account_id"
    },
    "git": {
      "username": "my_git_access_token"
    }
  }
}
```

Name the credentials file `creds.json`, and store it—along with your `[keypair filename].pem` file—in a directory called `$HOME/configs`.

</Step>

<Step>

## Run the application

Now that everything is set up, you can run the Deployer application in a Docker container:

```shell
docker run -it\
    -v $HOME/configs/:/mnt/deployer/configs/\
    --entrypoint ruby deployer main.rb -c configs/creds.json -d documentation/tutorial/user_stories/Hello/hello.json
```

With this command, you are running the `deployer` Docker container with the following options:

- `-v` mounts the `$HOME/configs` volume (where you stored your configuration files) at `/mnt/deployer/configs/` in the container
- `--entrypoint` sets the default command for Docker to `ruby`

Finally, you pass a list of arguments to the entrypoint, including:

- `-c configs/creds.json`: The user credentials configuration file
- `-d documentation/tutorial/user_stories/Hello/hello.json`: The [deployment configuration file](https://github.com/newrelic/demo-deployer/tree/main/documentation/deploy_config)

<Tip>

You can specify the log level for the Deployer using `-l`. `info` is the default, but you can also use `debug` or `error`. This is a helpful option to use when something goes wrong.

</Tip>

Once you run this command, the Deployer will create and instrument some specific resources. This may take a few minutes. In the meantime, read on to learn more about what is actually happening during this process.

#### Locating the user configuration files

Notice, in the Docker command, that `-c` takes `configs/creds.json`. Also, you referenced your `.pem` file from `configs/`, as well.

The reason for this is because you mounted `$HOME/configs` to `/mnt/deployer/configs/` and `/mnt/deployer/` is the working directory, according to the [Deployer's Dockerfile](https://github.com/newrelic/demo-deployer/blob/main/Dockerfile#L31). So, you can access your user configuration files at `configs/`, which is a relative path from your working directory.

#### Understanding the deployment configuration file

The deployment configuration file, [hello.json](https://github.com/newrelic/demo-deployer/blob/main/documentation/tutorial/user_stories/Hello/hello.json), which drives the Deployer, contains four sections:

- `services`
- `global_tags`
- `resources`
- `instrumentations`

These sections describe, to the Deployer, the actions it should execute.

The first section is `services`:

```json
{
  "services": [
    {
      "id": "app1",
      "display_name": "Hello-App1",
      "source_repository": "-b main https://github.com/newrelic/demo-nodetron.git",
      "deploy_script_path": "deploy/linux/roles",
      "port": 5001,
      "destinations": ["host1"],
      "files": [
        {
          "destination_filepath": "engine/data/index.json",
          "content": <some content>
        }
      ]
    }
  ]
}
```

`services` defines one service, `app1`, which lives on `host1` at port `5001`. It uses the Demo Nodetron you learned about earlier in this guide as its source.

The second section is `global_tags`:

```json
{
  "global_tags": {
    "dxOwningTeam": "DemoX",
    "dxEnvironment": "development",
    "dxDepartment": "Area51",
    "dxProduct": "Hello"
  }
}
```

`global_tags` defines tags for the Deployer to apply to _all_ the resources in your stack. These tags are an important part of organizing your New Relic entities.

The third section is `resources`:

```json
{
  "resources": [
    {
      "id": "host1",
      "display_name": "Hello-Host1",
      "provider": "aws",
      "type": "ec2",
      "size": "t3.micro"
    }
  ],
}
```

`resources` defines one host, `host1`, which is a small EC2 instance on AWS. This host is referred to in the `services` section.

The fourth, and final, section is `instrumentations`:

```json
{
  "instrumentations": {
    "resources": [
      {
        "id": "nr_infra",
        "resource_ids": ["host1"],
        "provider": "newrelic",
        "source_repository": "-b main https://github.com/newrelic/demo-newrelic-instrumentation.git",
        "deploy_script_path": "deploy/linux/roles",
        "version": "1.12.1"
      }
    ],
    "services": [
      {
        "id": "nr_node_agent",
        "service_ids": ["app1"],
        "provider": "newrelic",
        "source_repository": "-b main https://github.com/newrelic/demo-newrelic-instrumentation.git",
        "deploy_script_path": "deploy/node/linux/roles",
        "version": "6.11.0"
      }
    ]
  }
}
```

`instrumentations` configures, as the name implies, New Relic instrumentations for the `host1` infrastructure and the `app1` Node.js application. These definitions use the Demo New Relic Instrumentation project you learned about earlier.

</Step>

<Step>

## Generate some traffic

When Deployer has run successfully, you will see a message that describes the resources deployed and services installed during the process:

```shell
[INFO] Executing Deployment
[✔] Parsing and validating Deployment configuration success
[✔] Provisioner success
[✔] Installing On-Host instrumentation success
[✔] Installing Services and instrumentations success
[INFO] Deployment successful!

Deployed Resources:

  host1 (aws/ec2):
    ip: 52.90.86.109
    services: ["app1"]
    instrumentation:
       nr_infra: newrelic v1.12.1

Installed Services:

  app1:
    url: http://52.90.86.109:5001
    instrumentation:
       nr_node_agent: newrelic v6.11.0

Completed at 2020-08-20 15:11:14 +0000
```

Visit your application by navigating to the `app1` url in your browser:

![Hello World Web Site](../../images/automate-helloworld/helloworld-automationdemo.png)

From there, you can follow the instructions to send traffic to New Relic.

<Important>

Your `app1` url will be different than the url shown in this guide.

</Important>

</Step>

<Step>

## Check your tags

After you've generated some traffic to your Node.js application, use the New Relic [search redirect](https://one.newrelic.com/redirect/search/Hello) to find the resources you deployed:

![Search Redirect](../../images/automate-helloworld/global-search.png)

Once you have found your resources, select the service you deployed, `Hello-App1`.

By clicking on the 'i' icon next to the name, you'll open the _metadata and tags_ modal:

![Metadata and Tags](../../images/automate-helloworld/metadata.png)

Notice that all the tags in the `global_tags` section of the deployment configuration show up under _Tags_:

![Search Redirect](../../images/automate-helloworld/host-tags.png)

If you open the metadata modal for the host, you'll also see the `global_tags`.

</Step>

<Step>

## Teardown your resources

Because you've provisioned resources in your cloud account, you'll want to ensure to decommission them. You can do this with the Deployer.

Add the _teardown_ flag, `-t`, to the end of your command:

```shell
docker run -it\
    -v $HOME/configs/:/mnt/deployer/configs/\
    --entrypoint ruby deployer main.rb -c configs/creds.json -d documentation/tutorial/user_stories/Hello/hello.json -t
```

When the Deployer has finished successfully, you'll see output that is similar to what you saw during deployment:

```shell
[INFO] Executing Teardown
[✔] Parsing and validating Teardown configuration success
[✔] Provisioner success
[✔] Uninstalling On-Host instrumentation success
[✔] Uninstalling Services and instrumentations success
[✔] Terminating infrastructure success
[INFO] Teardown successful!
```

</Step>

</Steps>

## Next steps

Congratulations! Throughout this guide, you used the Demo Deployer to provision and instrument a host and application in AWS and automatically configured those entities with a list of tags.

Next, try creating your own deployment configuration and change the global tags! One cool thing you can do is pass in a configuration file URL to the Deployer.

Here's one that uses a gist on GitHub:

```shell
docker run -it\
    -v $HOME/configs/:/mnt/deployer/configs/\
    --entrypoint ruby deployer main.rb -c configs/creds.json -d https://gist.githubusercontent.com/markweitzel/d281fde8ca572ced6346dc25470790a5/raw/373166eb50929a0dd23ba5136abf2fa5caf3d369/MarksHelloDemoConfig.json
```